name: CI

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  backend:
    name: backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    env:
      DJANGO_SETTINGS_MODULE: adaptive_testing.settings.ci
      SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY || 'ci-secret-key-for-testing-only' }}
      DEBUG: false
      CORS_ALLOWED_ORIGINS: http://localhost:5173,http://127.0.0.1:5173
      # For non-PR events use a persistent secret; for PRs we'll set via Neon action
      DATABASE_URL: ${{ github.event_name != 'pull_request' && secrets.DATABASE_URL || '' }}
      PY_VERSION: '3.13.7'
    steps:
      - uses: actions/checkout@v6

      - name: Get branch expiration date (2 weeks from now)
        if: github.event_name == 'pull_request'
        id: get_expiration_date
        run: echo "EXPIRES_AT=$(date -u --date '+14 days' +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"

      - name: Create Neon Branch
        if: github.event_name == 'pull_request'
        id: create_neon_branch
        uses: neondatabase/create-branch-action@v6.3.0
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: preview/pr-${{ github.event.number }}-${{ github.event.pull_request.head.ref }}
          api_key: ${{ secrets.NEON_API_KEY }}
          expires_at: ${{ env.EXPIRES_AT }}

      - name: Set DATABASE_URL from Neon action
        if: github.event_name == 'pull_request'
        run: |
          echo "DATABASE_URL=${{ steps.create_neon_branch.outputs.db_url_pooled }}" >> "$GITHUB_ENV"

      - name: Export per-run test DB suffix
        if: github.event_name == 'pull_request'
        run: |
          echo "DJANGO_TEST_DB_SUFFIX=${{ github.run_id }}_${{ github.run_attempt }}" >> "$GITHUB_ENV"

      - name: Set up Python ${{ env.PY_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v5
        with:
            path: backend/.venv
            key: venv-${{ runner.os }}-${{ env.PY_VERSION }}-${{ hashFiles('**/poetry.lock') }}
      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root
      - name: Run linting
        run: poetry run ruff check .
      - name: Run type checking
        run: poetry run mypy .
      - name: Run migrations
        run: poetry run python manage.py migrate --noinput --settings=adaptive_testing.settings.ci
      - name: Run tests
        run: poetry run pytest --cov=adaptive_testing --cov=apps --cov-report=xml --cov-report=html --ds=adaptive_testing.settings.ci
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          verbose: true

      - name: Cleanup stray test databases
        if: always()
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          if [ -n "$DATABASE_URL" ]; then
            # Install PostgreSQL client
            sudo apt-get update && sudo apt-get install -y postgresql-client
            
            # Try to connect to 'postgres' database first (standard PostgreSQL)
            # If that fails, fall back to the original database (Neon might not have 'postgres' accessible)
            ADMIN_URL=$(echo "$DATABASE_URL" | sed 's|/[^/]*$|/postgres|')
            
            # Test if we can connect to postgres, otherwise use original database
            if ! psql "$ADMIN_URL" -c "SELECT 1;" > /dev/null 2>&1; then
              echo "Cannot connect to 'postgres' database, trying original database..."
              ADMIN_URL="$DATABASE_URL"
            fi
            
            # Drop all test_% databases, terminating active connections first
            # Note: DROP DATABASE cannot be executed from within a function, so we generate and execute statements
            psql "$ADMIN_URL" -tAc "SELECT datname FROM pg_database WHERE datname LIKE 'test_%' AND datistemplate = false" | while read -r dbname; do
              if [ -n "$dbname" ]; then
                # Terminate all connections to the database
                psql "$ADMIN_URL" -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '$dbname'" > /dev/null 2>&1 || true
                # Drop the database
                psql "$ADMIN_URL" -c "DROP DATABASE IF EXISTS \"$dbname\"" || true
              fi
            done || true
          fi

  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v6
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Run linting
        run: npm run lint
      - name: Run tests
        run: npm run test:run
      - name: Build
        run: npm run build

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: aztec-assess-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend Docker image (development)
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          target: development
          push: false
          tags: aztec-assess-frontend-dev:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend Docker image (production)
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          target: production
          push: false
          tags: aztec-assess-frontend-prod:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # GitLeaks - Secret scanning
      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      # CodeQL - Static analysis
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript, python

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
